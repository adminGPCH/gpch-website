@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject GpchFrontend.Services.ThemeService Theme
@using GpchFrontend.Services
@using GpchFrontend.Components
@inject NavigationManager Nav
@inject ThemeService Theme

<div class="page">
    @if (IsLoading)
    {
        <div class="gpch-transicion-wrapper">
            <FlorSVG Size="120" />
        </div>
    }
    else
    {
        <main>
            <div class="gpch-layout" style="--gpch-tema-color:@FondoTema; --gpch-tema-bkpimage:@BkpImageTema;">
                <AppBar />
                <div class="gpch-body">
                    @Body
                </div>
                <Footer />
            </div>
        </main>
    }
</div>

@code {
    private int FontSizeBase = ThemePalette.GetFontSizeBase("rojo");
    private int SpacingBase = ThemePalette.GetSpacingBase("rojo");
    private bool IsLoading = false;
    private string FondoTema = ThemePalette.GetColor("rojo");
    private string BkpImageTema = "none";

    protected override void OnInitialized()
    {
        Theme.OnThemeChanged += ActualizarEstilos;
        Navigation.LocationChanged += (_, __) =>
        {
            IsLoading = true;
            StateHasChanged();

            _ = Task.Run(async () =>
            {
                await Task.Delay(600); // duración de la transición
                IsLoading = false;
                await InvokeAsync(StateHasChanged);
            });
        };

        ActualizarEstilos();
    }

    private void ActualizarEstilos()
    {
        var tema = Theme.TemaActual;
        FontSizeBase = ThemePalette.GetFontSizeBase(tema);
        SpacingBase = ThemePalette.GetSpacingBase(tema);
        FondoTema = ThemePalette.GetColor(tema);
        BkpImageTema = ThemePalette.GetBackgroundImage(tema);
        StateHasChanged();
    }
}
